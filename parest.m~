% Data
V1=[22,  27.2;43,  210;78,  85.9;106,  81.1];
V2=[3,   469.8;11,  1600;15, 42.8;43,41.7];

tau=30;
tmax = 35;

% Resampling the data to produce data uniformly sampled in time
% fs = 1/mean(diff(p(:,1)));
% [y, Ty] = resample(p(:,2),p(:,1),fs);

% Creating matlab data object
data = iddata(log(y),[],fs)

% Setting up grey-box model
% fixed parameters
% c=3; pp=1e3; alpha=1;
% free parameters
k=3; theta=4; d=1e-3; Vmax=1e3;
order         = [1 0 3];
parameters    = [k, theta, d, Vmax, c, pp, alpha,tau, tmax];
initial_states = [10; 20; p(1,2)];
Ts            = 0;
nonlinear_model = idnlgrey('ode',order,parameters,initial_states,Ts);
nonlinear_model.Parameters(5).Fixed = true;
nonlinear_model.Parameters(6).Fixed = true;
nonlinear_model.Parameters(7).Fixed = true;
nonlinear_model.Parameters(8).Fixed = true;
nonlinear_model.Parameters(9).Fixed = true;

% Setting up parameter bounds
nonlinear_model.Parameters(1).Minimum = 0.22;
nonlinear_model.Parameters(1).Maximum = 4.73;
nonlinear_model.Parameters(2).Minimum = 10^(0.5);
nonlinear_model.Parameters(2).Maximum = 10^(4.2);
nonlinear_model.Parameters(3).Minimum = 0.08e-3;
nonlinear_model.Parameters(3).Maximum = 11.6e-3;

% Settings for fitting method
opt = nlgreyestOptions('SearchMethod','grad');
opt.SearchOption.Tolerance = 1e-3;
opt.Display='Full';
nonlinear_model = setinit(nonlinear_model, 'Fixed', {false false false}); % Estimate the initial states.
% Fit The model
nonlinear_model = nlgreyest(data,nonlinear_model,opt);

% Show fitted parameters
k=nonlinear_model.Parameters(1).Value
theta=nonlinear_model.Parameters(2).Value
d=nonlinear_model.Parameters(3).Value
Vmax=nonlinear_model.Parameters(4).Value

% Plot data and ODE fit
compare(data,nonlinear_model);

% initial conditions
% T0=nonlinear_model.InitialStates(1).Value;
% I0=nonlinear_model.InitialStates(2).Value;
% V0=nonlinear_model.InitialStates(3).Value;
%
%
% tspan=[0 Ty(end)];
% u=[];
% [t,x]=ode45(@(t,x) ode(t, x, u, k, theta, d, Vmax, c, pp, alpha, tau, tmax),tspan,[T0 I0 V0]);
% semilogy(t,x(:,3))
% ylabel('V')
% xlabel('time(day)')
% hold on;
% semilogy(Ty,y, 'o')
